<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Account Settings</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
<div class="max-w-3xl mx-auto p-6 space-y-8">
<h1 class="text-2xl font-bold">Account Settings</h1>

<!-- Third-party Account Linking -->
<section>
  <h2 class="text-lg font-semibold mb-2">Third-party Account Linking</h2>
  <div class="space-y-2">
    <div class="flex items-center justify-between bg-white p-4 rounded shadow">
      <div class="flex items-center gap-4">
        <img src="/icons/apple.svg" alt="Apple" class="w-6 h-6" />
        <div>
          <div class="font-medium">Apple</div>
          <div class="text-sm text-gray-500">apple@email.com</div>
        </div>
      </div>
      <button class="bg-red-500 text-white px-3 py-1 rounded">Unlink</button>
    </div>

    <div class="flex items-center justify-between bg-white p-4 rounded shadow">
      <div class="flex items-center gap-4">
        <img src="/icons/google.svg" alt="Google" class="w-6 h-6" />
        <div>
          <div class="font-medium">Google</div>
          <div class="text-sm text-gray-400">Not Linked</div>
        </div>
      </div>
      <button class="bg-green-500 text-white px-3 py-1 rounded">Link</button>
    </div>
  </div>
</section>

<!-- Phone Verification -->
<section>
  <h2 class="text-lg font-semibold mb-2">Phone Verification</h2>
  <div class="flex items-center justify-between bg-white p-4 rounded shadow">
    <div>
      <div class="font-medium">+886 912-345-678</div>
      <div class="text-sm text-green-600">Verified</div>
    </div>
    <button class="bg-gray-300 text-gray-800 px-3 py-1 rounded">Unbind</button>
  </div>
</section>

<!-- Password Management -->
<section>
  <h2 class="text-lg font-semibold mb-2">Password Management</h2>
  <div class="flex items-center justify-between bg-white p-4 rounded shadow">
    <div class="font-mono">••••••••</div>
    <button class="bg-blue-500 text-white px-3 py-1 rounded">Change</button>
  </div>
</section>

<!-- Account Merge Suggestions -->
<section>
  <h2 class="text-lg font-semibold mb-2">Account Merge Suggestions</h2>
  <div class="space-y-2">
    <div class="flex items-center justify-between bg-white p-4 rounded shadow">
      <div>
        <div class="font-medium">test@email.com (iBubble)</div>
      </div>
      <div class="space-x-2">
        <button class="bg-green-500 text-white px-3 py-1 rounded">Merge</button>
        <button class="bg-gray-300 text-gray-800 px-3 py-1 rounded">Ignore</button>
      </div>
    </div>
  </div>
</section>

</div>
</body><!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>帳號合併建議範例（已修正 Reduce 錯誤，並加入測試）</title>
<style>
/* 簡易樣式，實務上可改用 Tailwind 或設計系統 */
:root{--bg:#f7f8fa;--card:#ffffff;--accent:#0b74de;--muted:#6b7280}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans TC',sans-serif;background:var(--bg);margin:0;padding:24px}
.container{max-width:960px;margin:0 auto}
.card{background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(12,14,20,0.06);padding:20px;margin-bottom:16px}
h1{margin:0 0 8px;font-size:20px}
h2{margin:0 0 8px;font-size:16px}
p{margin:0;color:var(--muted)}
.account-list{display:flex;gap:12px;margin-top:16px}
.acct{flex:1;border:1px solid #edf2f7;padding:12px;border-radius:8px}
.acct .meta{font-size:13px;color:var(--muted)}
.actions{display:flex;gap:8px;margin-top:16px}
button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff}
.btn-ghost{background:transparent;border:1px solid #e6e9ef;color:#111}
.hint{font-size:13px;color:var(--muted);margin-top:8px}
.status{margin-top:12px;font-size:14px}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid #cbd5e1;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
pre{background:#0f1724;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
.debug-small{font-size:13px;color:var(--muted);margin-top:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* 小螢幕調整 */
@media (max-width:640px){.account-list{flex-direction:column}}
</style>
</head>
<body>
<div class="container">
<div class="card" id="merge-suggestion" aria-live="polite">
<h1>系統偵測到可能可合併的帳號</h1>
<p class="hint">我們發現多個使用相同 Email 的帳號。合併可讓你只保留一組登入與資料。</p>
  <div class="account-list" id="account-list">
    <!-- 動態載入帳號項目 -->
  </div>

  <div class="actions">
    <button class="btn-primary" id="merge-btn">合併選取的帳號</button>
    <button class="btn-ghost" id="dismiss-btn">暫不合併</button>
  </div>

  <div class="status" id="status"></div>
</div>

<!-- 測試與除錯區塊：用於重現與驗證修正 (開發專用) -->
<div class="card">
  <h2>測試與除錯</h2>
  <p class="debug-small">（開發用）按下以下按鈕可以載入不同的測試資料，或執行自動測試驗證 primary 的決策邏輯。</p>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
    <button id="test-empty">載入測試：空陣列</button>
    <button id="test-single-primary">載入測試：單一（含 primary）</button>
    <button id="test-multiple-no-primary">載入測試：多個（無 primary）</button>
    <button id="test-multiple-with-primary">載入測試：多個（有 primary）</button>
    <button id="test-invalid-dates">載入測試：錯誤或缺少 createdAt</button>
    <button id="test-same-dates">載入測試：建立時間相同</button>
    <button id="run-all-tests">執行所有測試</button>
  </div>
  <div id="debug-info" class="debug-small"></div>
  <pre id="test-results" style="margin-top:12px;max-height:220px"></pre>
</div>
</div>
<script>
// 範例 API:
// GET /api/user/merge-account -> 回傳候選帳號陣列：{ candidates: [ { id, provider, displayName, createdAt, primary }, ... ] }
// POST /api/user/merge-account -> json { keep: id, merge: [id,...] } 回傳 { ok: true, mergedTo: id, warnings: [] }


const accountListEl = document.getElementById('account-list');
const statusEl = document.getElementById('status');
const mergeBtn = document.getElementById('merge-btn');
const dismissBtn = document.getElementById('dismiss-btn');
const debugInfoEl = document.getElementById('debug-info');
const testResultsEl = document.getElementById('test-results');

// 全域狀態
let candidates = []; // 伺服器回來的候選
let checked = new Set();

function showStatus(message, busy=false, isError=false) {
  statusEl.innerHTML = '';
  if(busy){
    const s = document.createElement('span'); s.className='spinner';
    statusEl.appendChild(s);
  }
  const t = document.createElement('span');
  t.textContent = message;
  t.style.color = isError ? '#b91c1c' : 'inherit';
  statusEl.appendChild(t);
}

function showDebug(message){
  debugInfoEl.textContent = message;
}

// 強健的 primary 決策：將 list 傳入，回傳 primary 或 null
// 預設行為（可修改）：
// 1) 若有 explicit primary (c.primary === true) -> 回傳該帳號
// 2) 否則選擇 createdAt 最早的帳號（createdAt 解析失敗視為 Infinity）
// 3) 若 list 為空或非陣列，回傳 null
function computePrimary(list){
  if(!Array.isArray(list) || list.length === 0) return null;
  // 優先找到 explicit primary
  const explicit = list.find(c => c && c.primary === true);
  if(explicit) return explicit;

  // 若無 explicit primary，選擇最早建立的（createdAt 最早）
  const parseTs = (item) => {
    if(!item) return Number.POSITIVE_INFINITY;
    const d = new Date(item.createdAt);
    return isNaN(d.getTime()) ? Number.POSITIVE_INFINITY : d.getTime();
  };

  // 使用 reduce 時提供初始值以避免空陣列錯誤；這裡初始值為 list[0]
  return list.reduce((a, b) => {
    return parseTs(a) <= parseTs(b) ? a : b;
  }, list[0]);
}

async function fetchCandidates(){
  showStatus('載入中...', true);
  try{
    const res = await fetch('/api/user/merge-account');
    if(!res.ok) throw new Error('伺服器回應 '+res.status);
    const data = await res.json();
    candidates = data.candidates || [];
    renderCandidates();
    showStatus(candidates.length ? '請選擇要合併的帳號' : '找不到可合併的帳號');
  }catch(err){
    showStatus('載入候選帳號失敗：'+err.message, false, true);
  }
}

function renderCandidates(){
  accountListEl.innerHTML = '';
  if(!Array.isArray(candidates) || candidates.length===0){
    accountListEl.innerHTML = '<div class="acct">目前沒有偵測到其他帳號</div>';
    mergeBtn.disabled = true;
    checked = new Set();
    showDebug('候選為空');
    return;
  }

  const primary = computePrimary(candidates);

  candidates.forEach(acc => {
    const div = document.createElement('div');
    div.className = 'acct';
    const isPrimary = primary && acc && acc.id === primary.id;
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div><strong>${escapeHtml(acc.displayName || acc.provider || acc.id)}</strong></div>
          <div class="meta">${escapeHtml(acc.provider || '')} • 建立於 ${acc && acc.createdAt ? new Date(acc.createdAt).toLocaleDateString() : '未知'}</div>
        </div>
        <div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" data-id="${acc.id}" ${isPrimary ? 'checked disabled' : ''} ${isPrimary ? 'data-primary="true"' : ''} />
            <span class="meta">${isPrimary ? '主要帳號' : '合併'}</span>
          </label>
        </div>
      </div>
    `;
    accountListEl.appendChild(div);
  });

  // 綁定 checkbox 事件
  accountListEl.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.disabled) return;
      if(e.target.checked) checked.add(id); else checked.delete(id);
      mergeBtn.disabled = checked.size < 1;
    });
  });

  // 預設：選取非主要帳號
  checked = new Set(candidates.filter(c=>!(primary && c && c.id === primary.id)).map(c=>c.id));
  accountListEl.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    if(!cb.disabled && checked.has(cb.dataset.id)) cb.checked = true;
  });
  mergeBtn.disabled = checked.size < 1;

  showDebug('已載入 ' + candidates.length + ' 個候選帳號；系統預設保留：' + (primary ? (primary.displayName || primary.id) : '（無）'));
}

mergeBtn.addEventListener('click', async ()=>{
  const mergeIds = Array.from(checked);
  if(mergeIds.length===0){ showStatus('請先選擇要合併的帳號', false, true); return; }

  // 安全計算 primary（避免在空陣列上呼叫 reduce）
  const primary = computePrimary(candidates);
  if(!primary){
    showStatus('找不到可用的保留帳號，請重新載入候選帳號或選擇要保留的帳號。', false, true);
    return;
  }

  // 準備要送出的合併清單（排除要保留的帳號）
  const merges = mergeIds.filter(id => id !== primary.id);
  if(merges.length === 0){
    showStatus('沒有選擇要合併到主要帳號的其他帳號。', false, true);
    return;
  }

  const payload = { keep: primary.id, merge: merges };

  // 顯示確認小窗（簡易）
  if(!confirm(`你將把 ${payload.merge.length} 個帳號合併到 ${primary.displayName || primary.id}。此動作不可逆，是否繼續？`)) return;

  showStatus('合併中...', true);
  mergeBtn.disabled = true; dismissBtn.disabled = true;

  try{
    const res = await fetch('/api/user/merge-account', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const errText = await res.text();
      throw new Error('伺服器錯誤：'+res.status+' '+errText);
    }
    const result = await res.json();
    if(result.ok){
      showStatus('合併完成，帳號已合併至：'+ (result.mergedTo || primary.displayName || primary.id));
      // 依據實際需求：重新導向、刷新、或顯示詳細結果
      setTimeout(()=>{ window.location.reload(); }, 1200);
    }else{
      const warn = (result.warnings && result.warnings.join('; ')) || '未知回應';
      showStatus('合併失敗：' + warn, false, true);
      mergeBtn.disabled = false; dismissBtn.disabled = false;
    }
  }catch(err){
    showStatus('合併失敗：'+err.message, false, true);
    mergeBtn.disabled = false; dismissBtn.disabled = false;
  }
});

dismissBtn.addEventListener('click', async ()=>{
  // 可選：告知後端暫時忽略
  if(!confirm('確定暫不合併？系統將在下次登入時再次提示。')) return;
  try{
    await fetch('/api/user/merge-account/dismiss', { method: 'POST' });
    showStatus('已暫時關閉此提示');
  }catch(e){ showStatus('無法關閉提示：'+e.message, false, true); }
});

// 小工具：防 XSS 的基礎 escape
function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

// -------------------- 測試資料與自動測試 --------------------
const TESTS = {
  empty: [],
  singlePrimary: [
    { id: 'a1', provider: 'native', displayName: 'User A (Primary)', createdAt: '2020-01-01T09:00:00Z', primary: true }
  ],
  multipleNoPrimary: [
    { id: 'b1', provider: 'google', displayName: 'Google A', createdAt: '2021-05-01T09:00:00Z' },
    { id: 'b2', provider: 'apple', displayName: 'Apple B', createdAt: '2020-12-12T09:00:00Z' },
    { id: 'b3', provider: 'line', displayName: 'Line C', createdAt: '2022-02-02T09:00:00Z' }
  ],
  multipleWithPrimary: [
    { id: 'c1', provider: 'line', displayName: 'Line A', createdAt: '2021-01-01T09:00:00Z' },
    { id: 'c2', provider: 'native', displayName: 'Main User', createdAt: '2020-05-05T09:00:00Z', primary: true },
    { id: 'c3', provider: 'facebook', displayName: 'FB User', createdAt: '2023-03-03T09:00:00Z' }
  ],
  invalidDates: [
    { id: 'd1', provider: 'google', displayName: 'Bad Date 1', createdAt: 'not-a-date' },
    { id: 'd2', provider: 'apple', displayName: 'No Date 2' },
    { id: 'd3', provider: 'line', displayName: 'Good Date 3', createdAt: '2019-07-07T12:00:00Z' }
  ],
  sameDates: [
    { id: 'e1', provider: 'google', displayName: 'Same A', createdAt: '2021-01-01T00:00:00Z' },
    { id: 'e2', provider: 'apple', displayName: 'Same B', createdAt: '2021-01-01T00:00:00Z' }
  ]
};

document.getElementById('test-empty').addEventListener('click', ()=> loadTest('empty'));
document.getElementById('test-single-primary').addEventListener('click', ()=> loadTest('singlePrimary'));
document.getElementById('test-multiple-no-primary').addEventListener('click', ()=> loadTest('multipleNoPrimary'));
document.getElementById('test-multiple-with-primary').addEventListener('click', ()=> loadTest('multipleWithPrimary'));
document.getElementById('test-invalid-dates').addEventListener('click', ()=> loadTest('invalidDates'));
document.getElementById('test-same-dates').addEventListener('click', ()=> loadTest('sameDates'));
document.getElementById('run-all-tests').addEventListener('click', runAllTests);

function loadTest(key){
  const t = TESTS[key] || [];
  candidates = JSON.parse(JSON.stringify(t)); // clone
  renderCandidates();
  const p = computePrimary(candidates);
  showDebug('Loaded test: ' + key + ' → primary: ' + (p ? (p.displayName || p.id) : '（無）'));
  testResultsEl.textContent = '';
}

function runAllTests(){
  const results = [];
  for(const k of Object.keys(TESTS)){
    const arr = TESTS[k];
    const p = computePrimary(arr);
    results.push({ test: k, count: arr.length, primary: p ? (p.id + (p.displayName ? ' ('+p.displayName+')' : '') ) : null });
  }
  testResultsEl.textContent = JSON.stringify(results, null, 2);
  showDebug('已執行 ' + Object.keys(TESTS).length + ' 個測試，結果見下方');
}

// 初始化：若要連線到真實 API，請啟用 fetchCandidates();
// fetchCandidates();

// 預設載入一組測試資料，方便開發驗證。請在生產環境移除或關閉。
candidates = TESTS.multipleWithPrimary.slice();
renderCandidates();

const accountListEl = document.getElementById('account-list');
const statusEl = document.getElementById('status');
const mergeBtn = document.getElementById('merge-btn');
const dismissBtn = document.getElementById('dismiss-btn');
const debugInfoEl = document.getElementById('debug-info');
const testResultsEl = document.getElementById('test-results');

// 全域狀態
let candidates = []; // 伺服器回來的候選
let checked = new Set();

function showStatus(message, busy=false, isError=false) {
  statusEl.innerHTML = '';
  if(busy){
    const s = document.createElement('span'); s.className='spinner';
    statusEl.appendChild(s);
  }
  const t = document.createElement('span');
  t.textContent = message;
  t.style.color = isError ? '#b91c1c' : 'inherit';
  statusEl.appendChild(t);
}

function showDebug(message){
  debugInfoEl.textContent = message;
}

// 強健的 primary 決策：將 list 傳入，回傳 primary 或 null
// 預設行為（可修改）：
// 1) 若有 explicit primary (c.primary === true) -> 回傳該帳號
// 2) 否則選擇 createdAt 最早的帳號（createdAt 解析失敗視為 Infinity）
// 3) 若 list 為空或非陣列，回傳 null
function computePrimary(list){
  if(!Array.isArray(list) || list.length === 0) return null;
  // 優先找到 explicit primary
  const explicit = list.find(c => c && c.primary === true);
  if(explicit) return explicit;

  // 若無 explicit primary，選擇最早建立的（createdAt 最早）
  const parseTs = (item) => {
    if(!item) return Number.POSITIVE_INFINITY;
    const d = new Date(item.createdAt);
    return isNaN(d.getTime()) ? Number.POSITIVE_INFINITY : d.getTime();
  };

  // 使用 reduce 時提供初始值以避免空陣列錯誤；這裡初始值為 list[0]
  return list.reduce((a, b) => {
    return parseTs(a) <= parseTs(b) ? a : b;
  }, list[0]);
}

async function fetchCandidates(){
  showStatus('載入中...', true);
  try{
    const res = await fetch('/api/user/merge-account');
    if(!res.ok) throw new Error('伺服器回應 '+res.status);
    const data = await res.json();
    candidates = data.candidates || [];
    renderCandidates();
    showStatus(candidates.length ? '請選擇要合併的帳號' : '找不到可合併的帳號');
  }catch(err){
    showStatus('載入候選帳號失敗：'+err.message, false, true);
  }
}

function renderCandidates(){
  accountListEl.innerHTML = '';
  if(!Array.isArray(candidates) || candidates.length===0){
    accountListEl.innerHTML = '<div class="acct">目前沒有偵測到其他帳號</div>';
    mergeBtn.disabled = true;
    checked = new Set();
    showDebug('候選為空');
    return;
  }

  const primary = computePrimary(candidates);

  candidates.forEach(acc => {
    const div = document.createElement('div');
    div.className = 'acct';
    const isPrimary = primary && acc && acc.id === primary.id;
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div><strong>${escapeHtml(acc.displayName || acc.provider || acc.id)}</strong></div>
          <div class="meta">${escapeHtml(acc.provider || '')} • 建立於 ${acc && acc.createdAt ? new Date(acc.createdAt).toLocaleDateString() : '未知'}</div>
        </div>
        <div>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" data-id="${acc.id}" ${isPrimary ? 'checked disabled' : ''} ${isPrimary ? 'data-primary="true"' : ''} />
            <span class="meta">${isPrimary ? '主要帳號' : '合併'}</span>
          </label>
        </div>
      </div>
    `;
    accountListEl.appendChild(div);
  });

  // 綁定 checkbox 事件
  accountListEl.querySelectorAll('input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', (e)=>{
      const id = e.target.dataset.id;
      if(e.target.disabled) return;
      if(e.target.checked) checked.add(id); else checked.delete(id);
      mergeBtn.disabled = checked.size < 1;
    });
  });

  // 預設：選取非主要帳號
  checked = new Set(candidates.filter(c=>!(primary && c && c.id === primary.id)).map(c=>c.id));
  accountListEl.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    if(!cb.disabled && checked.has(cb.dataset.id)) cb.checked = true;
  });
  mergeBtn.disabled = checked.size < 1;

  showDebug('已載入 ' + candidates.length + ' 個候選帳號；系統預設保留：' + (primary ? (primary.displayName || primary.id) : '（無）'));
}

mergeBtn.addEventListener('click', async ()=>{
  const mergeIds = Array.from(checked);
  if(mergeIds.length===0){ showStatus('請先選擇要合併的帳號', false, true); return; }

  // 安全計算 primary（避免在空陣列上呼叫 reduce）
  const primary = computePrimary(candidates);
  if(!primary){
    showStatus('找不到可用的保留帳號，請重新載入候選帳號或選擇要保留的帳號。', false, true);
    return;
  }

  // 準備要送出的合併清單（排除要保留的帳號）
  const merges = mergeIds.filter(id => id !== primary.id);
  if(merges.length === 0){
    showStatus('沒有選擇要合併到主要帳號的其他帳號。', false, true);
    return;
  }

  const payload = { keep: primary.id, merge: merges };

  // 顯示確認小窗（簡易）
  if(!confirm(`你將把 ${payload.merge.length} 個帳號合併到 ${primary.displayName || primary.id}。此動作不可逆，是否繼續？`)) return;

  showStatus('合併中...', true);
  mergeBtn.disabled = true; dismissBtn.disabled = true;

  try{
    const res = await fetch('/api/user/merge-account', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const errText = await res.text();
      throw new Error('伺服器錯誤：'+res.status+' '+errText);
    }
    const result = await res.json();
    if(result.ok){
      showStatus('合併完成，帳號已合併至：'+ (result.mergedTo || primary.displayName || primary.id));
      // 依據實際需求：重新導向、刷新、或顯示詳細結果
      setTimeout(()=>{ window.location.reload(); }, 1200);
    }else{
      const warn = (result.warnings && result.warnings.join('; ')) || '未知回應';
      showStatus('合併失敗：' + warn, false, true);
      mergeBtn.disabled = false; dismissBtn.disabled = false;
    }
  }catch(err){
    showStatus('合併失敗：'+err.message, false, true);
    mergeBtn.disabled = false; dismissBtn.disabled = false;
  }
});

dismissBtn.addEventListener('click', async ()=>{
  // 可選：告知後端暫時忽略
  if(!confirm('確定暫不合併？系統將在下次登入時再次提示。')) return;
  try{
    await fetch('/api/user/merge-account/dismiss', { method: 'POST' });
    showStatus('已暫時關閉此提示');
  }catch(e){ showStatus('無法關閉提示：'+e.message, false, true); }
});

// 小工具：防 XSS 的基礎 escape
function escapeHtml(s){ if(!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" })[c]); }

// -------------------- 測試資料與自動測試 --------------------
const TESTS = {
  empty: [],
  singlePrimary: [
    { id: 'a1', provider: 'native', displayName: 'User A (Primary)', createdAt: '2020-01-01T09:00:00Z', primary: true }
  ],
  multipleNoPrimary: [
    { id: 'b1', provider: 'google', displayName: 'Google A', createdAt: '2021-05-01T09:00:00Z' },
    { id: 'b2', provider: 'apple', displayName: 'Apple B', createdAt: '2020-12-12T09:00:00Z' },
    { id: 'b3', provider: 'line', displayName: 'Line C', createdAt: '2022-02-02T09:00:00Z' }
  ],
  multipleWithPrimary: [
    { id: 'c1', provider: 'line', displayName: 'Line A', createdAt: '2021-01-01T09:00:00Z' },
    { id: 'c2', provider: 'native', displayName: 'Main User', createdAt: '2020-05-05T09:00:00Z', primary: true },
    { id: 'c3', provider: 'facebook', displayName: 'FB User', createdAt: '2023-03-03T09:00:00Z' }
  ],
  invalidDates: [
    { id: 'd1', provider: 'google', displayName: 'Bad Date 1', createdAt: 'not-a-date' },
    { id: 'd2', provider: 'apple', displayName: 'No Date 2' },
    { id: 'd3', provider: 'line', displayName: 'Good Date 3', createdAt: '2019-07-07T12:00:00Z' }
  ],
  sameDates: [
    { id: 'e1', provider: 'google', displayName: 'Same A', createdAt: '2021-01-01T00:00:00Z' },
    { id: 'e2', provider: 'apple', displayName: 'Same B', createdAt: '2021-01-01T00:00:00Z' }
  ]
};

document.getElementById('test-empty').addEventListener('click', ()=> loadTest('empty'));
document.getElementById('test-single-primary').addEventListener('click', ()=> loadTest('singlePrimary'));
document.getElementById('test-multiple-no-primary').addEventListener('click', ()=> loadTest('multipleNoPrimary'));
document.getElementById('test-multiple-with-primary').addEventListener('click', ()=> loadTest('multipleWithPrimary'));
document.getElementById('test-invalid-dates').addEventListener('click', ()=> loadTest('invalidDates'));
document.getElementById('test-same-dates').addEventListener('click', ()=> loadTest('sameDates'));
document.getElementById('run-all-tests').addEventListener('click', runAllTests);

function loadTest(key){
  const t = TESTS[key] || [];
  candidates = JSON.parse(JSON.stringify(t)); // clone
  renderCandidates();
  const p = computePrimary(candidates);
  showDebug('Loaded test: ' + key + ' → primary: ' + (p ? (p.displayName || p.id) : '（無）'));
  testResultsEl.textContent = '';
}

function runAllTests(){
  const results = [];
  for(const k of Object.keys(TESTS)){
    const arr = TESTS[k];
    const p = computePrimary(arr);
    results.push({ test: k, count: arr.length, primary: p ? (p.id + (p.displayName ? ' ('+p.displayName+')' : '') ) : null });
  }
  testResultsEl.textContent = JSON.stringify(results, null, 2);
  showDebug('已執行 ' + Object.keys(TESTS).length + ' 個測試，結果見下方');
}

// 初始化：若要連線到真實 API，請啟用 fetchCandidates();
// fetchCandidates();

// 預設載入一組測試資料，方便開發驗證。請在生產環境移除或關閉。
candidates = TESTS.multipleWithPrimary.slice();
renderCandidates();
